#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
set -e

bashio::log.info "Starting Trash Tracking Add-on..."

# Generate config.yaml from Home Assistant add-on options
bashio::log.info "Generating configuration from add-on options..."

cat > /app/config.yaml <<EOF
# Auto-generated configuration from Home Assistant Add-on options
system:
  log_level: $(bashio::config 'system.log_level')
  cache_enabled: false
  cache_ttl: 60

location:
  lat: $(bashio::config 'location.lat')
  lng: $(bashio::config 'location.lng')

tracking:
  target_lines: $(bashio::config 'tracking.target_lines' | jq -c '.')
  enter_point: "$(bashio::config 'tracking.enter_point')"
  exit_point: "$(bashio::config 'tracking.exit_point')"
  trigger_mode: "$(bashio::config 'tracking.trigger_mode')"
  approaching_threshold: $(bashio::config 'tracking.approaching_threshold')

api:
  ntpc:
    base_url: "https://crd-rubbish.epd.ntpc.gov.tw/WebAPI"
    timeout: $(bashio::config 'api.ntpc.timeout')
    retry_count: $(bashio::config 'api.ntpc.retry_count')
    retry_delay: $(bashio::config 'api.ntpc.retry_delay')

  server:
    host: "0.0.0.0"
    port: 5000
    debug: false
EOF

bashio::log.info "Configuration file generated successfully"
bashio::log.debug "Config content:"
cat /app/config.yaml

# Create logs directory if it doesn't exist
mkdir -p /app/logs

# Start the application with gunicorn
bashio::log.info "Starting Trash Tracking service..."
exec gunicorn app:app \
    --bind 0.0.0.0:5000 \
    --workers 2 \
    --timeout 120 \
    --access-logfile - \
    --error-logfile - \
    --log-level info
