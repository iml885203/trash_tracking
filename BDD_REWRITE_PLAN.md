# BDD Feature é‡å¯«è¨ˆç•«

> **ç›®æ¨™**: å°‡ BDD feature æ–‡ä»¶å¾æŠ€è¡“è¦–è§’æ”¹å¯«ç‚ºçœŸæ­£çš„ä½¿ç”¨è€…è¦–è§’ï¼Œç¬¦åˆ BDD ç²¾ç¥
>
> **é æœŸæ•ˆç›Š**:
> - éæŠ€è¡“äººå“¡ï¼ˆPMã€ä½¿ç”¨è€…ï¼‰å¯ä»¥é–±è®€å’Œç†è§£
> - Feature æ–‡ä»¶å¯ä½œç‚ºéœ€æ±‚æ–‡ä»¶ä½¿ç”¨
> - èšç„¦æ–¼ä½¿ç”¨è€…åƒ¹å€¼ï¼Œè€ŒéæŠ€è¡“å¯¦ä½œ
>
> **å®Œæˆæ¢ä»¶**: æ‰€æœ‰ BDD æ¸¬è©¦é€šé + feature æ–‡ä»¶å¯è¢«éæŠ€è¡“äººå“¡ç†è§£

---

## ğŸ“‹ ä»»å‹™æ¸…å–®

### Phase 1: åˆ†æèˆ‡è¦åŠƒ âœ…

- [x] å»ºç«‹é‡å¯«è¨ˆç•«æ–‡ä»¶
- [ ] åˆ†ææ¯å€‹ feature éœ€è¦æ”¹å¯«çš„éƒ¨åˆ†
  - [ ] cli_query.feature - è§’è‰²ã€å ´æ™¯åç¨±ã€æ­¥é©Ÿæè¿°
  - [ ] config_flow.feature - å®Œå…¨é‡å¯«ï¼ˆæŠ€è¡“è¡“èªéå¤šï¼‰
  - [ ] integration_imports.feature - æ±ºå®šä¿ç•™æˆ–åˆªé™¤

### Phase 2: é‡å¯« Feature æ–‡ä»¶

#### Task 2.1: é‡å¯« cli_query.feature (å„ªå…ˆåº¦: ä¸­)

**å•é¡Œè¨ºæ–·**:
- âŒ è§’è‰²å®šç¾©ç‚ºã€Œé–‹ç™¼è€…ã€ï¼Œæ‡‰ç‚ºã€Œå±…æ°‘ã€
- âŒ å ´æ™¯åç¨±å¤ªæŠ€è¡“åŒ–
- âš ï¸ æ­¥é©Ÿæè¿°å¯ä»¥æ›´è²¼è¿‘çœŸå¯¦æƒ…å¢ƒ

**æ”¹å¯«é‡é»**:
```gherkin
# æ”¹å‰
ä½œç‚ºä¸€å€‹é–‹ç™¼è€…
æˆ‘æƒ³è¦ä½¿ç”¨ CLI æŸ¥è©¢åƒåœ¾è»Šè³‡è¨Š

# æ”¹å¾Œ
ä½œç‚ºä¸€å€‹æ–°åŒ—å¸‚å±…æ°‘
æˆ‘æƒ³è¦çŸ¥é“åƒåœ¾è»Šä»€éº¼æ™‚å€™æœƒåˆ°æˆ‘å®¶é™„è¿‘
ä»¥ä¾¿ä¸æœƒéŒ¯éå€’åƒåœ¾çš„æ™‚é–“
```

**æ–°å ´æ™¯åç¨±**:
1. ~~ä½¿ç”¨åœ°å€æŸ¥è©¢åƒåœ¾è»Š~~ â†’ **æŸ¥è©¢æˆ‘å®¶é™„è¿‘çš„åƒåœ¾è»Š**
2. ~~ä½¿ç”¨åœ°å€å’Œè‡ªè¨‚æœå°‹åŠå¾‘~~ â†’ **æ“´å¤§æœå°‹ç¯„åœæ‰¾åƒåœ¾è»Š**
3. ~~éæ¿¾ç‰¹å®šè·¯ç·š~~ â†’ **åªé—œå¿ƒç‰¹å®šè·¯ç·šçš„åƒåœ¾è»Š**
4. ~~æŸ¥è©¢ç„¡æ•ˆåœ°å€~~ â†’ **è¼¸å…¥éŒ¯èª¤çš„åœ°å€**

**éœ€è¦æ–°å¢çš„ step definitions**:
- `å‡è¨­ æˆ‘ä½åœ¨ "{address}"`
- `ç•¶ æˆ‘æŸ¥è©¢é™„è¿‘çš„åƒåœ¾è»Š`
- `ç•¶ æˆ‘æ“´å¤§æœå°‹ç¯„åœåˆ° {è·é›¢} å…¬é‡Œ`
- `ç•¶ æˆ‘ä¸å°å¿ƒè¼¸å…¥äº†éŒ¯èª¤çš„åœ°å€ "{address}"`

**é è¨ˆå½±éŸ¿**:
- æª”æ¡ˆ: `features/cli_query.feature`
- Step definitions: `features/steps/cli_steps.py` (éœ€æ›´æ–°)

---

#### Task 2.2: é‡å¯« config_flow.feature (å„ªå…ˆåº¦: é«˜)

**å•é¡Œè¨ºæ–·**:
- âŒ å ´æ™¯åç¨±å®Œå…¨æ˜¯æŠ€è¡“è¦–è§’
- âŒ æ­¥é©Ÿå……æ»¿æŠ€è¡“è¡“èªï¼ˆgeocode, fetch, analyzeï¼‰
- âŒ ç„¡æ³•è®“éæŠ€è¡“äººå“¡ç†è§£

**æ”¹å¯«é‡é»**:
```gherkin
# æ”¹å‰
Feature: Integration Config Flow
  As a Home Assistant user
  I want to set up the Trash Tracking integration

# æ”¹å¾Œ
åŠŸèƒ½: è¨­å®šåƒåœ¾è»Šåˆ°å®¶é€šçŸ¥
  ä½œç‚ºä¸€å€‹ Home Assistant ä½¿ç”¨è€…
  æˆ‘æƒ³è¦è¨­å®šåƒåœ¾è»Šæ¥è¿‘æ™‚è‡ªå‹•é€šçŸ¥æˆ‘
  ä»¥ä¾¿æˆ‘ä¸æœƒéŒ¯éå€’åƒåœ¾çš„æ™‚é–“
```

**æ–°å ´æ™¯**:
1. ~~Successfully configure integration with valid address~~ â†’ **ç¬¬ä¸€æ¬¡è¨­å®šæˆ‘å®¶çš„åƒåœ¾è»Šé€šçŸ¥**
2. ~~Geocoding fails with invalid address~~ â†’ **è¼¸å…¥çš„åœ°å€æ‰¾ä¸åˆ°**
3. ~~No routes found for remote location~~ â†’ **æˆ‘ä½çš„åœ°æ–¹å¤ªåé æ²’æœ‰åƒåœ¾è»Šè·¯ç·š**
4. ~~Route recommendation includes collection points~~ â†’ **ç¢ºèªé¸æ“‡çš„è·¯ç·šåŒ…å«æˆ‘å®¶é™„è¿‘çš„æ”¶é›†é»**

**å»é™¤æŠ€è¡“è¡“èª**:
- âŒ "When I geocode the address" â†’ âœ… "ç•¶ æˆ‘è¼¸å…¥æˆ‘å®¶åœ°å€"
- âŒ "When I fetch nearby routes" â†’ âœ… "é‚£éº¼ ç³»çµ±æ‡‰è©²æ‰¾åˆ°æˆ‘å®¶é™„è¿‘çš„åƒåœ¾è»Šè·¯ç·š"
- âŒ "When I analyze the routes" â†’ âœ… "è€Œä¸” æˆ‘æ‡‰è©²èƒ½é¸æ“‡è¦è¿½è¹¤çš„è·¯ç·š"

**éœ€è¦æ–°å¢çš„ step definitions**:
- `ç•¶ æˆ‘åœ¨ Home Assistant ä¸­æ–°å¢åƒåœ¾è»Šè¿½è¹¤æ•´åˆ`
- `è€Œä¸” æˆ‘è¼¸å…¥æˆ‘å®¶åœ°å€`
- `é‚£éº¼ ç³»çµ±æ‡‰è©²æ‰¾åˆ°æˆ‘å®¶é™„è¿‘çš„åƒåœ¾è»Šè·¯ç·š`
- `è€Œä¸” æˆ‘æ‡‰è©²èƒ½é¸æ“‡è¦è¿½è¹¤çš„è·¯ç·š`
- `é‚£éº¼ ç³»çµ±æ‡‰è©²å‘Šè¨´æˆ‘ã€Œæ‰¾ä¸åˆ°é€™å€‹åœ°å€ã€`

**é è¨ˆå½±éŸ¿**:
- æª”æ¡ˆ: `features/config_flow.feature`
- Step definitions: `features/steps/config_flow_steps.py` (éœ€å¤§å¹…æ›´æ–°)

---

#### Task 2.3: è™•ç† integration_imports.feature (å„ªå…ˆåº¦: é«˜)

**å•é¡Œè¨ºæ–·**:
- âŒ æ•´å€‹ feature å®Œå…¨æ˜¯æŠ€è¡“æ¸¬è©¦
- âŒ æ²’æœ‰ä½¿ç”¨è€…åƒ¹å€¼
- âŒ ä¸é©åˆç”¨ BDD æ’°å¯«

**æ±ºç­–é¸é …**:

**é¸é … A: åˆªé™¤ä¸¦ç§»è‡³ pytest (å»ºè­°)**
- å°‡ import æ¸¬è©¦æ”¹ç‚º pytest å–®å…ƒæ¸¬è©¦
- åœ¨ `tests/test_integration_imports.py` ä¸­å¯¦ä½œ
- BDD åªä¿ç•™ä½¿ç”¨è€…ç›¸é—œå ´æ™¯

**é¸é … B: æ”¹å¯«æˆä½¿ç”¨è€…è¦–è§’ (ä¸å»ºè­°)**
```gherkin
åŠŸèƒ½: æ•´åˆå¯ä»¥åœ¨ Home Assistant ä¸­æ­£å¸¸å•Ÿå‹•
  ä½œç‚ºä¸€å€‹ Home Assistant ä½¿ç”¨è€…
  æˆ‘æƒ³è¦ç¢ºä¿åƒåœ¾è»Šè¿½è¹¤æ•´åˆå¯ä»¥æ­£å¸¸å®‰è£å’Œè¼‰å…¥

  å ´æ™¯: å®‰è£æ•´åˆå¾Œé¦–æ¬¡å•Ÿå‹• Home Assistant
    å‡è¨­ æˆ‘å·²ç¶“å°‡åƒåœ¾è»Šè¿½è¹¤æ•´åˆè¤‡è£½åˆ° custom_components ç›®éŒ„
    ç•¶ Home Assistant å•Ÿå‹•ä¸¦è¼‰å…¥æ•´åˆ
    é‚£éº¼ æ•´åˆæ‡‰è©²æˆåŠŸè¼‰å…¥
```

**å»ºè­°**: é¸æ“‡é¸é … Aï¼Œåˆªé™¤ feature æ–‡ä»¶ï¼Œæ”¹ç”¨ pytest

**éœ€è¦åŸ·è¡Œ**:
1. åˆªé™¤ `features/integration_imports.feature`
2. åˆªé™¤ `features/steps/integration_imports_steps.py`
3. å‰µå»º `tests/test_integration_imports.py`ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

### Phase 3: æ›´æ–° Step Definitions

#### Task 3.1: æ›´æ–° cli_steps.py

**éœ€è¦æ–°å¢çš„æ­¥é©Ÿ**:
```python
@given('æˆ‘ä½åœ¨ "{address}"')
def step_i_live_at(context, address):
    """è¨˜éŒ„ä½¿ç”¨è€…åœ°å€"""
    context.address = address

@when('æˆ‘æŸ¥è©¢é™„è¿‘çš„åƒåœ¾è»Š')
def step_query_nearby_trucks(context):
    """æŸ¥è©¢é™„è¿‘åƒåœ¾è»Šï¼ˆä½¿ç”¨é è¨­åŠå¾‘ï¼‰"""
    # å¯¦ä½œèˆ‡ç¾æœ‰ step_query_by_address é¡ä¼¼

@when('æˆ‘æ“´å¤§æœå°‹ç¯„åœåˆ° {distance:d} å…¬é‡Œ')
def step_expand_search_radius(context, distance):
    """æ“´å¤§æœå°‹ç¯„åœ"""
    # è½‰æ›å…¬é‡Œç‚ºå…¬å°ºï¼Œå‘¼å« CLI
```

**éœ€è¦ä¿®æ”¹çš„æ­¥é©Ÿ**:
- ä¿ç•™ç¾æœ‰å¯¦ä½œé‚è¼¯
- åªä¿®æ”¹ decorator çš„ Gherkin æ–‡å­—

---

#### Task 3.2: å¤§å¹…æ›´æ–° config_flow_steps.py

**éœ€è¦æ–°å¢çš„æ­¥é©Ÿ**:
```python
@when('æˆ‘åœ¨ Home Assistant ä¸­æ–°å¢åƒåœ¾è»Šè¿½è¹¤æ•´åˆ')
def step_add_integration(context):
    """æ¨¡æ“¬åœ¨ HA ä¸­æ–°å¢æ•´åˆçš„è¡Œç‚º"""
    pass  # è¨­å®š context åˆå§‹ç‹€æ…‹

@when('æˆ‘è¼¸å…¥æˆ‘å®¶åœ°å€')
def step_input_address(context):
    """è¼¸å…¥åœ°å€ä¸¦è‡ªå‹•é€²è¡Œ geocoding"""
    # åŒ…è£åŸæœ‰çš„ geocoding é‚è¼¯

@then('ç³»çµ±æ‡‰è©²æ‰¾åˆ°æˆ‘å®¶é™„è¿‘çš„åƒåœ¾è»Šè·¯ç·š')
def step_should_find_routes(context):
    """é©—è­‰æ‰¾åˆ°è·¯ç·š"""
    # åŒ…è£åŸæœ‰çš„ fetch routes å’Œé©—è­‰é‚è¼¯

@then('ç³»çµ±æ‡‰è©²å‘Šè¨´æˆ‘ã€Œ{message}ã€')
def step_should_show_message(context, message):
    """é©—è­‰é¡¯ç¤ºç‰¹å®šè¨Šæ¯"""
    # æª¢æŸ¥éŒ¯èª¤è¨Šæ¯å…§å®¹
```

---

### Phase 4: æ¸¬è©¦èˆ‡é©—è­‰

#### Task 4.1: åŸ·è¡Œæ¸¬è©¦ç¢ºèªé€šé

**æ¸¬è©¦æª¢æŸ¥æ¸…å–®**:
```bash
# 1. åŸ·è¡Œæ‰€æœ‰ BDD æ¸¬è©¦ï¼ˆä½¿ç”¨ mockï¼‰
[ ] USE_MOCK_API=true python -m behave features/ --summary

# 2. åŸ·è¡ŒçœŸå¯¦ API æ¸¬è©¦ï¼ˆæ¨™è¨˜ @real_api çš„å ´æ™¯ï¼‰
[ ] USE_MOCK_API=false python -m behave features/ --tags=@real_api

# 3. é©—è­‰æ¸¬è©¦è¦†è“‹åº¦
[ ] ç¢ºèªæ‰€æœ‰ä½¿ç”¨è€…å ´æ™¯éƒ½æœ‰æ¸¬è©¦
[ ] ç¢ºèªéŒ¯èª¤è™•ç†å ´æ™¯éƒ½æœ‰æ¸¬è©¦

# 4. å¯è®€æ€§æ¸¬è©¦
[ ] è«‹éæŠ€è¡“äººå“¡é–±è®€ feature æ–‡ä»¶
[ ] ç¢ºèªä»–å€‘èƒ½ç†è§£æ¯å€‹å ´æ™¯çš„æ„ç¾©
```

**é æœŸçµæœ**:
- âœ… æ‰€æœ‰æ¸¬è©¦é€šé
- âœ… æ¸¬è©¦è¦†è“‹åº¦ä¸é™ä½
- âœ… éæŠ€è¡“äººå“¡èƒ½è®€æ‡‚ feature æ–‡ä»¶

---

#### Task 4.2: æ›´æ–°æ–‡ä»¶

**éœ€è¦æ›´æ–°çš„æ–‡ä»¶**:
1. `features/README.md`
   - æ›´æ–°ç¯„ä¾‹ feature æ–‡ä»¶
   - å¼·èª¿ä½¿ç”¨è€…è¦–è§’çš„é‡è¦æ€§
   - æ–°å¢ã€Œå¦‚ä½•æ’°å¯«å¥½çš„ BDD å ´æ™¯ã€ç« ç¯€

2. `DEVELOPMENT.md`
   - æ›´æ–° BDD æ¸¬è©¦èªªæ˜
   - å¼·èª¿é‡å¯«å¾Œçš„æ”¹é€²

3. `CLAUDE.md` (å¦‚æœéœ€è¦)
   - æ›´æ–° BDD ç›¸é—œçš„é–‹ç™¼æŒ‡å¼•

---

### Phase 5: å®Œæˆèˆ‡æ¸…ç†

#### Task 5.1: Commit è®Šæ›´

**Commit è¨Šæ¯å»ºè­°**:
```
refactor(bdd): rewrite features from user perspective

BREAKING CHANGE: Rewrite all BDD feature files to focus on user value

- Rewrite cli_query.feature with user-centric scenarios
- Rewrite config_flow.feature removing technical jargon
- Remove integration_imports.feature (moved to unit tests)
- Update all step definitions to match new scenarios
- Update features/README.md with best practices

Features now readable by non-technical stakeholders and serve
as executable requirements documentation.

Closes #[issue_number]
```

**æª¢æŸ¥æ¸…å–®**:
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] Pre-commit hooks é€šé
- [ ] æ–‡ä»¶å·²æ›´æ–°
- [ ] Git commit è¨Šæ¯æ¸…æ¥š

---

#### Task 5.2: åˆªé™¤æ­¤è¨ˆç•«æ–‡ä»¶

**å®Œæˆæ¢ä»¶**:
- âœ… æ‰€æœ‰ Phase 1-5 ä»»å‹™å®Œæˆ
- âœ… æ‰€æœ‰æ¸¬è©¦é€šé
- âœ… è®Šæ›´å·² commit ä¸¦ push

**æœ€å¾Œæ­¥é©Ÿ**:
```bash
rm BDD_REWRITE_PLAN.md
git add BDD_REWRITE_PLAN.md
git commit -m "chore: remove BDD rewrite plan (completed)"
git push origin master
```

---

## ğŸ“Š é€²åº¦è¿½è¹¤

### å®Œæˆåº¦çµ±è¨ˆ

- [ ] Phase 1: åˆ†æèˆ‡è¦åŠƒ (0/2)
- [ ] Phase 2: é‡å¯« Feature æ–‡ä»¶ (0/3)
- [ ] Phase 3: æ›´æ–° Step Definitions (0/2)
- [ ] Phase 4: æ¸¬è©¦èˆ‡é©—è­‰ (0/2)
- [ ] Phase 5: å®Œæˆèˆ‡æ¸…ç† (0/2)

**ç¸½é€²åº¦**: 0/11 (0%)

---

## ğŸ’¡ é‡å¯«åŸå‰‡æé†’

### å¥½çš„ BDD å ´æ™¯ç‰¹å¾µ:

1. **âœ… ä½¿ç”¨è€…èªè¨€**: é¿å…æŠ€è¡“è¡“èª
   - âŒ "When I geocode the address"
   - âœ… "ç•¶æˆ‘è¼¸å…¥æˆ‘å®¶åœ°å€"

2. **âœ… èšç„¦åƒ¹å€¼**: æè¿°ä½¿ç”¨è€…æƒ³é”æˆä»€éº¼
   - âŒ "Import all modules"
   - âœ… "ç¢ºä¿æ•´åˆå¯ä»¥æ­£å¸¸å•Ÿå‹•"

3. **âœ… çœŸå¯¦æƒ…å¢ƒ**: æè¿°ä½¿ç”¨è€…å¯¦éš›æœƒé‡åˆ°çš„æƒ…æ³
   - âŒ "Successfully configure integration"
   - âœ… "ç¬¬ä¸€æ¬¡è¨­å®šæˆ‘å®¶çš„åƒåœ¾è»Šé€šçŸ¥"

4. **âœ… æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯**: ä½¿ç”¨è€…èƒ½ç†è§£çš„éŒ¯èª¤èªªæ˜
   - âŒ "geocoding should fail with an error"
   - âœ… "ç³»çµ±æ‡‰è©²å‘Šè¨´æˆ‘ã€Œæ‰¾ä¸åˆ°é€™å€‹åœ°å€ï¼Œè«‹ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºã€"

### é¿å…çš„åæ¨¡å¼:

- âŒ åœ¨å ´æ™¯ä¸­æè¿°å¯¦ä½œç´°ç¯€
- âŒ ä½¿ç”¨é–‹ç™¼è€…æ‰æ‡‚çš„è¡“èª
- âŒ æ¸¬è©¦æŠ€è¡“åŠŸèƒ½è€Œéä½¿ç”¨è€…åƒ¹å€¼
- âŒ éæ–¼ç°¡åŒ–å°è‡´å ´æ™¯ä¸çœŸå¯¦

---

## ğŸ“ Notes & Decisions

### æ±ºç­–è¨˜éŒ„:

**2025-11-23**:
- æ±ºå®šå»ºç«‹æ­¤é‡å¯«è¨ˆç•«
- ç¢ºèªä¸‰å€‹ feature æ–‡ä»¶éƒ½éœ€è¦æ”¹å¯«
- integration_imports.feature å»ºè­°åˆªé™¤æ”¹ç”¨ pytest

### å•é¡Œèˆ‡é¢¨éšª:

1. **é¢¨éšª**: é‡å¯«å¯èƒ½å°è‡´æ¸¬è©¦è¦†è“‹åº¦ä¸‹é™
   - **ç·©è§£**: ç¢ºä¿æ–°å ´æ™¯ä»è¦†è“‹åŸæœ‰çš„æ¸¬è©¦é‚è¼¯

2. **æŒ‘æˆ°**: ä¸­æ–‡å’Œè‹±æ–‡æ··ç”¨å¯èƒ½é€ æˆæ··æ·†
   - **æ±ºç­–**: cli_query ä½¿ç”¨ä¸­æ–‡ï¼ˆé¢å‘çµ‚ç«¯ä½¿ç”¨è€…ï¼‰
   - **æ±ºç­–**: config_flow ä½¿ç”¨ä¸­æ–‡ï¼ˆé¢å‘ HA ä½¿ç”¨è€…ï¼‰

3. **æ™‚é–“**: å®Œæ•´é‡å¯«é è¨ˆéœ€è¦ 2-3 å°æ™‚
   - **å»ºè­°**: åˆ†éšæ®µåŸ·è¡Œï¼Œæ¯å€‹ feature å®Œæˆå¾Œå³æ¸¬è©¦

---

## âœ… å®Œæˆæª¢æŸ¥è¡¨

æœ€çµ‚é©—è­‰ï¼ˆæ‰€æœ‰é …ç›®éƒ½è¦å‹¾é¸æ‰èƒ½åˆªé™¤æ­¤è¨ˆç•«ï¼‰:

- [ ] æ‰€æœ‰ feature æ–‡ä»¶å·²æ”¹å¯«å®Œæˆ
- [ ] æ‰€æœ‰ step definitions å·²æ›´æ–°
- [ ] æ¸¬è©¦å…¨éƒ¨é€šéï¼ˆmock + real APIï¼‰
- [ ] éæŠ€è¡“äººå“¡å¯ä»¥è®€æ‡‚ feature æ–‡ä»¶
- [ ] æ–‡ä»¶å·²æ›´æ–°ï¼ˆREADME.mdï¼‰
- [ ] è®Šæ›´å·² commit ä¸¦ push
- [ ] æ­¤è¨ˆç•«æ–‡ä»¶å·²åˆªé™¤

---

**å»ºç«‹æ™‚é–“**: 2025-11-23
**é è¨ˆå®Œæˆ**: 2025-11-24
**è² è²¬äºº**: Claude + User
