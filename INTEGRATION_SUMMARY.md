# ğŸ‰ åƒåœ¾è»Šè¿½è¹¤ Integration å¯¦ä½œå®Œæˆç¸½çµ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒ Integration æª”æ¡ˆ (11 å€‹)

```
custom_components/trash_tracking/
â”œâ”€â”€ __init__.py              âœ… Integration åˆå§‹åŒ–å’Œç”Ÿå‘½é€±æœŸç®¡ç†
â”œâ”€â”€ manifest.json            âœ… Integration å®£å‘Š (domain, version, etc.)
â”œâ”€â”€ const.py                 âœ… å¸¸æ•¸å®šç¾© (ç‹€æ…‹ã€å±¬æ€§éµç­‰)
â”œâ”€â”€ config_flow.py           âœ… UI è¨­å®šæµç¨‹ + Options Flow
â”œâ”€â”€ coordinator.py           âœ… è³‡æ–™æ›´æ–°å”èª¿å™¨ (è¼ªè©¢ Add-on API)
â”œâ”€â”€ sensor.py                âœ… 2 å€‹æ„Ÿæ¸¬å™¨å¯¦é«”
â”œâ”€â”€ binary_sensor.py         âœ… 1 å€‹äºŒå…ƒæ„Ÿæ¸¬å™¨å¯¦é«”
â”œâ”€â”€ strings.json             âœ… é è¨­ç¿»è­¯å­—ä¸²
â”œâ”€â”€ translations/
â”‚   â”œâ”€â”€ en.json              âœ… è‹±æ–‡ç¿»è­¯
â”‚   â””â”€â”€ zh-Hant.json         âœ… ç¹é«”ä¸­æ–‡ç¿»è­¯
â””â”€â”€ README.md                âœ… Integration ä½¿ç”¨èªªæ˜
```

### 2. BDD æ¸¬è©¦æª”æ¡ˆ (3 å€‹)

```
features/
â”œâ”€â”€ integration_config_flow.feature          âœ… 80+ æ¸¬è©¦å ´æ™¯
â”œâ”€â”€ integration_entities.feature             âœ… 40+ æ¸¬è©¦å ´æ™¯
â””â”€â”€ integration_addon_coexistence.feature    âœ… 30+ æ¸¬è©¦å ´æ™¯
```

**æ¸¬è©¦æ¶µè“‹:**
- è¨­å®šæµç¨‹ (åŸºæœ¬ã€å¤šæ­¥é©Ÿã€éŒ¯èª¤è™•ç†)
- å¯¦é«”åŠŸèƒ½ (sensor, binary_sensor, å±¬æ€§)
- è³‡æ–™æ›´æ–°å’Œå”èª¿
- Add-on å…±å­˜å’Œç›¸å®¹æ€§
- æ•ˆèƒ½å’Œè³‡æºä½¿ç”¨
- éŒ¯èª¤è™•ç†å’Œæ¢å¾©
- å¤šèªè¨€æ”¯æ´
- ç§»è½‰è·¯å¾‘

### 3. æ–‡ä»¶ (2 å€‹)

```
â”œâ”€â”€ INTEGRATION_GUIDE.md     âœ… å®Œæ•´å¯¦ä½œæŒ‡å—å’ŒæŠ€è¡“æ–‡ä»¶
â””â”€â”€ INTEGRATION_SUMMARY.md   âœ… æœ¬æª”æ¡ˆ
```

---

## ğŸ¯ Integration åŠŸèƒ½ç‰¹è‰²

### è‡ªå‹•å»ºç«‹çš„å¯¦é«”

å®‰è£ Integration å¾Œæœƒè‡ªå‹•å»ºç«‹:

1. **`sensor.trash_tracking_status`**
   - ç‹€æ…‹: `idle` / `nearby`
   - åŒ…å«å®Œæ•´çš„åƒåœ¾è»Šè³‡è¨Šå±¬æ€§

2. **`sensor.trash_tracking_truck_info`**
   - é¡¯ç¤ºè·¯ç·šå’Œè»Šç‰Œ
   - åŒ…å«ç«™é»ã€å»¶é²æ™‚é–“ç­‰è©³ç´°è³‡è¨Š

3. **`binary_sensor.trash_truck_nearby`**
   - ç”¨æ–¼è‡ªå‹•åŒ–è§¸ç™¼
   - `on` = åƒåœ¾è»Šæ¥è¿‘, `off` = ç„¡åƒåœ¾è»Š

### æ ¸å¿ƒå„ªå‹¢

âœ… **ç„¡éœ€ç·¨å¯« YAML** - UI è¨­å®š,æ¯” RESTful Sensor ç°¡å–®
âœ… **åŸç”Ÿæ•´åˆ** - æ‰€æœ‰å¯¦é«”æ­¸å±¬æ–¼åŒä¸€å€‹è£ç½®
âœ… **Options Flow** - å¯åœ¨ UI ä¸­èª¿æ•´æƒæé–“éš”
âœ… **è‡ªå‹•éŒ¯èª¤è™•ç†** - Coordinator è‡ªå‹•é‡è©¦å’Œæ¢å¾©
âœ… **å®Œå…¨ä¿ç•™ Add-on** - Setup Wizardã€APIã€CLI éƒ½ä¸å—å½±éŸ¿
âœ… **å‘å¾Œç›¸å®¹** - å¯èˆ‡ç¾æœ‰ RESTful Sensor å…±å­˜

---

## ğŸ“Š æ¶æ§‹è¨­è¨ˆ

### è³‡æ–™æµç¨‹

```
New Taipei City API
        â†“
    Add-on (Flask)
    - Setup Wizard (é…ç½®)
    - Tracker Logic (è¿½è¹¤)
    - State Manager (ç‹€æ…‹)
    - REST API (æä¾›è³‡æ–™)
        â†“
    /api/trash/status
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“              â†“
RESTful Sensor    Integration    CLI Tool
(èˆŠæ–¹å¼/å¯é¸)      (æ–°æ–¹å¼)       (ä¿ç•™)
                     â†“
           Coordinator (è¼ªè©¢)
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“            â†“            â†“
    Sensor      Sensor      Binary Sensor
   (status)   (truck_info)   (nearby)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
                è‡ªå‹•åŒ–/å„€è¡¨æ¿
```

### é—œéµè¨­è¨ˆæ±ºç­–

1. **Integration ä¸å–ä»£ Add-on**
   - Add-on ä¿ç•™æ‰€æœ‰åŠŸèƒ½
   - Integration åªæ˜¯"å‰ç«¯"
   - ç”¨æˆ¶å¯é¸æ“‡ä½¿ç”¨å“ªç¨®æ–¹å¼

2. **è¼ªè©¢æ¨¡å¼ (Polling)**
   - ä½¿ç”¨ DataUpdateCoordinator
   - é è¨­ 90 ç§’é–“éš”
   - è‡ªå‹•éŒ¯èª¤è™•ç†å’Œé‡è©¦

3. **ç„¡ç‹€æ…‹è¨­è¨ˆ**
   - Integration ä¸å„²å­˜ç‹€æ…‹
   - æ‰€æœ‰ç‹€æ…‹ç”± Add-on ç®¡ç†
   - Integration åªæ˜¯è½‰æ›è³‡æ–™æ ¼å¼

4. **å‘å¾Œç›¸å®¹**
   - API æ ¼å¼ä¿æŒä¸è®Š
   - RESTful Sensor ä»ç„¶å¯ç”¨
   - å¹³æ»‘çš„ç§»è½‰è·¯å¾‘

---

## ğŸš€ å®‰è£å’Œä½¿ç”¨

### å‰ææ¢ä»¶

```bash
# 1. å¿…é ˆå…ˆå®‰è£ Add-on
# 2. ä½¿ç”¨ Setup Wizard é…ç½®è·¯ç·š
# 3. ç¢ºèª Add-on æ­£å¸¸é‹è¡Œ
curl http://localhost:5000/health
```

### å®‰è£ Integration

**æ–¹æ³• 1: æ‰‹å‹•å®‰è£**
```bash
cd /config
mkdir -p custom_components
cp -r custom_components/trash_tracking custom_components/
# é‡å•Ÿ Home Assistant
```

**æ–¹æ³• 2: HACS (æœªä¾†)**
```
1. HACS â†’ Integrations
2. Custom repositories â†’ æ–°å¢ repository
3. æœå°‹ "Trash Tracking" â†’ å®‰è£
```

### è¨­å®š Integration

```
è¨­å®š â†’ è£ç½®èˆ‡æœå‹™ â†’ + æ–°å¢æ•´åˆ
â†’ æœå°‹ "Trash Tracking"
â†’ è¼¸å…¥ API URL: http://localhost:5000
â†’ è¨­å®šæƒæé–“éš”: 90 ç§’
â†’ æäº¤
```

### ä½¿ç”¨å¯¦é«”

```yaml
# è‡ªå‹•åŒ–ç¯„ä¾‹
automation:
  - alias: "åƒåœ¾è»Šæ¥è¿‘ - é–‹ç‡ˆ"
    trigger:
      - platform: state
        entity_id: binary_sensor.trash_truck_nearby
        to: 'on'
    action:
      - service: light.turn_on
        target:
          entity_id: light.notification_bulb
```

---

## ğŸ§ª æ¸¬è©¦è¨ˆç•«

### æ‰‹å‹•æ¸¬è©¦æ¸…å–®

- [ ] **å®‰è£æ¸¬è©¦**
  - [ ] è¤‡è£½æª”æ¡ˆåˆ° custom_components
  - [ ] é‡å•Ÿ HA ç„¡éŒ¯èª¤
  - [ ] Integration å‡ºç¾åœ¨å¯ç”¨æ•´åˆåˆ—è¡¨

- [ ] **è¨­å®šæ¸¬è©¦**
  - [ ] è¼¸å…¥æ­£ç¢ºçš„ API URL æˆåŠŸ
  - [ ] è¼¸å…¥éŒ¯èª¤çš„ URL é¡¯ç¤ºéŒ¯èª¤
  - [ ] é˜²æ­¢é‡è¤‡æ–°å¢ç›¸åŒ URL

- [ ] **å¯¦é«”æ¸¬è©¦**
  - [ ] å»ºç«‹ 3 å€‹å¯¦é«”
  - [ ] å¯¦é«”æœ‰æ­£ç¢ºçš„åç¨±å’Œåœ–ç¤º
  - [ ] å¯¦é«”æ­¸å±¬æ–¼åŒä¸€å€‹è£ç½®

- [ ] **è³‡æ–™æ›´æ–°æ¸¬è©¦**
  - [ ] Add-on ç‹€æ…‹ idle â†’ Integration é¡¯ç¤º idle
  - [ ] Add-on ç‹€æ…‹ nearby â†’ Integration é¡¯ç¤º nearby
  - [ ] å±¬æ€§åŒ…å«å®Œæ•´çš„åƒåœ¾è»Šè³‡è¨Š

- [ ] **Options Flow æ¸¬è©¦**
  - [ ] å¯ä»¥èª¿æ•´æƒæé–“éš”
  - [ ] æ–°é–“éš”ç”Ÿæ•ˆ

- [ ] **éŒ¯èª¤è™•ç†æ¸¬è©¦**
  - [ ] Add-on åœæ­¢ â†’ Integration æ¨™è¨˜ä¸å¯ç”¨
  - [ ] Add-on æ¢å¾© â†’ Integration è‡ªå‹•é‡é€£

- [ ] **å…±å­˜æ¸¬è©¦**
  - [ ] RESTful Sensor å’Œ Integration åŒæ™‚é‹ä½œ
  - [ ] è³‡æ–™ä¸€è‡´
  - [ ] ç„¡è¡çª

### BDD æ¸¬è©¦åŸ·è¡Œ

```bash
# å®‰è£ä¾è³´
pip install behave

# åŸ·è¡Œæ‰€æœ‰ Integration æ¸¬è©¦
behave features/integration_*.feature

# åŸ·è¡Œç‰¹å®šæª”æ¡ˆ
behave features/integration_config_flow.feature
behave features/integration_entities.feature
behave features/integration_addon_coexistence.feature

# ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š
behave -f html -o reports/integration_test.html features/integration_*.feature
```

---

## ğŸ“ˆ æ•ˆèƒ½æŒ‡æ¨™

### è³‡æºä½¿ç”¨ (ä¼°è¨ˆ)

| çµ„ä»¶ | CPU | Memory | Network |
|------|-----|--------|---------|
| Add-on | 2-5% | ~50 MB | NTPC API: 90s/æ¬¡ |
| Integration | <1% | ~10 MB | Local API: 90s/æ¬¡ |
| **ç¸½è¨ˆ** | <6% | ~60 MB | æ¥µå° (æœ¬åœ°é€šè¨Š) |

### æ•ˆèƒ½å„ªåŒ–

- âœ… ä½¿ç”¨ DataUpdateCoordinator (å…±ç”¨è³‡æ–™)
- âœ… æœ¬åœ° API å‘¼å« (ç„¡å¤–ç¶²å»¶é²)
- âœ… åˆç†çš„è¼ªè©¢é–“éš” (90 ç§’)
- âœ… è‡ªå‹•éŒ¯èª¤æ¢å¾© (ä¸é˜»å¡)

---

## ğŸ”„ èˆ‡ç¾æœ‰ç³»çµ±çš„ç›¸å®¹æ€§

### Add-on åŠŸèƒ½ 100% ä¿ç•™

| åŠŸèƒ½ | Add-on | Integration | å‚™è¨» |
|------|--------|-------------|------|
| Setup Wizard | âœ… | - | Add-on æä¾› |
| è·¯ç·šé…ç½® | âœ… | - | åœ¨ Add-on è¨­å®š |
| REST API | âœ… | âœ… | Integration æ¶ˆè²» |
| CLI å·¥å…· | âœ… | - | Add-on æä¾› |
| ç‹€æ…‹è¿½è¹¤ | âœ… | - | Add-on æ ¸å¿ƒé‚è¼¯ |
| RESTful Sensor | âœ… | - | ä»å¯ä½¿ç”¨ |
| åŸç”Ÿå¯¦é«” | - | âœ… | Integration æä¾› |
| UI è¨­å®š | - | âœ… | Integration æä¾› |

### ç§»è½‰è·¯å¾‘

**å¾ RESTful Sensor åˆ° Integration:**

```yaml
# æ­¥é©Ÿ 1: å®‰è£ Integration (ä¿ç•™ RESTful Sensor)
# æ­¥é©Ÿ 2: é€æ­¥æ›´æ–°è‡ªå‹•åŒ–
#   èˆŠ: sensor.garbage_truck_monitor
#   æ–°: sensor.trash_tracking_status

# æ­¥é©Ÿ 3: ç¢ºèªæ‰€æœ‰è‡ªå‹•åŒ–æ­£å¸¸
# æ­¥é©Ÿ 4: ç§»é™¤ RESTful Sensor é…ç½®
# æ­¥é©Ÿ 5: é‡å•Ÿ HA
```

**å¥½è™•:**
- é›¶åœæ©Ÿæ™‚é–“
- é€æ­¥ç§»è½‰
- å¯éš¨æ™‚å›é€€

---

## ğŸ“ æœªä¾†æ”¹é€²æ–¹å‘

### çŸ­æœŸ (v1.1)

- [ ] æ–°å¢æ›´å¤š sensor (è·é›¢ã€é è¨ˆåˆ°é”æ™‚é–“)
- [ ] æ”¯æ´å¤šå€‹è¿½è¹¤é»
- [ ] æ–°å¢ device_tracker å¯¦é«”
- [ ] æ”¹é€²éŒ¯èª¤è¨Šæ¯

### ä¸­æœŸ (v2.0)

- [ ] å¤šæ­¥é©Ÿæ™ºèƒ½è¨­å®šæµç¨‹ (åœ°å€è‡ªå‹•å»ºè­°)
- [ ] æ•´åˆ Add-on çš„ auto-suggest API
- [ ] åœ–å½¢åŒ–è·¯ç·šé¸æ“‡
- [ ] æ”¯æ´é€šçŸ¥æœå‹™

### é•·æœŸ (v3.0)

- [ ] å°‡æ‰€æœ‰é‚è¼¯ç§»åˆ° Integration (ä¸ä¾è³´ Add-on)
- [ ] ç›´æ¥å‘¼å« NTPC API
- [ ] å…§å»º Setup Wizard UI
- [ ] å®Œå…¨ç¨ç«‹é‹ä½œ

---

## ğŸ“ æŠ€è¡“äº®é»

### 1. æ¶æ§‹åˆ†é›¢

```
Add-on (Backend)      Integration (Frontend)
     â†“                        â†“
  è³‡æ–™æº                    UI æ•´åˆ
  é…ç½®ç®¡ç†                  å¯¦é«”ç®¡ç†
  è¿½è¹¤é‚è¼¯                  è‡ªå‹•åŒ–å‹å–„
```

### 2. DataUpdateCoordinator æ¨¡å¼

```python
# å–®ä¸€è³‡æ–™æº,å¤šå€‹æ¶ˆè²»è€…
Coordinator.data â†’ [Sensor1, Sensor2, BinarySensor]
                â†’ æ‰€æœ‰å¯¦é«”åŒæ­¥æ›´æ–°
                â†’ åªå‘¼å«ä¸€æ¬¡ API
```

### 3. é˜²è­·æ€§ç¨‹å¼è¨­è¨ˆ

- API é€£æ¥é©—è­‰
- é˜²æ­¢é‡è¤‡æ–°å¢
- è‡ªå‹•éŒ¯èª¤æ¢å¾©
- è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

### 4. ä½¿ç”¨è€…é«”é©—å„ªåŒ–

- UI è¨­å®š (ç„¡éœ€ YAML)
- å‹å–„çš„éŒ¯èª¤è¨Šæ¯
- å¤šèªè¨€æ”¯æ´
- å®Œæ•´çš„æ–‡ä»¶

---

## ğŸ“ æ”¯æ´å’Œç¤¾ç¾¤

### æ–‡ä»¶è³‡æº

- âœ… Integration README (`custom_components/trash_tracking/README.md`)
- âœ… å¯¦ä½œæŒ‡å— (`INTEGRATION_GUIDE.md`)
- âœ… BDD æ¸¬è©¦æª”æ¡ˆ (150+ å ´æ™¯)
- ğŸ“ ä¸» README (å¾…æ›´æ–°)

### å•é¡Œå›å ±

```
GitHub Issues: https://github.com/iml885203/trash_tracking/issues

å ±å‘Šå•é¡Œæ™‚è«‹æä¾›:
1. Home Assistant ç‰ˆæœ¬
2. Add-on ç‰ˆæœ¬
3. Integration ç‰ˆæœ¬
4. éŒ¯èª¤æ—¥èªŒ
5. é‡ç¾æ­¥é©Ÿ
```

---

## âœ¨ ç¸½çµ

### å®Œæˆåº¦

| é …ç›® | ç‹€æ…‹ | å®Œæˆåº¦ |
|------|------|--------|
| Integration æ ¸å¿ƒ | âœ… | 100% |
| å¯¦é«”å¯¦ä½œ | âœ… | 100% |
| Config Flow | âœ… | 100% |
| ç¿»è­¯æª”æ¡ˆ | âœ… | 100% |
| BDD æ¸¬è©¦ | âœ… | 100% |
| æ–‡ä»¶ | âœ… | 100% |
| å¯¦éš›æ¸¬è©¦ | ğŸ”„ | å¾…åŸ·è¡Œ |
| HACS æ•´åˆ | ğŸ“ | å¾…ç™¼å¸ƒ |

### é—œéµæˆå°±

âœ… **å®Œå…¨ä¸ç ´å£ç¾æœ‰åŠŸèƒ½** - Add-on 100% ä¿ç•™
âœ… **æä¾›æ›´å¥½çš„æ•´åˆé«”é©—** - åŸç”Ÿ HA å¯¦é«”
âœ… **è©³ç›¡çš„æ¸¬è©¦è¦†è“‹** - 150+ BDD å ´æ™¯
âœ… **å®Œæ•´çš„æ–‡ä»¶** - æŠ€è¡“æ–‡ä»¶ + ä½¿ç”¨èªªæ˜
âœ… **å¤šèªè¨€æ”¯æ´** - è‹±æ–‡ + ç¹é«”ä¸­æ–‡
âœ… **å¯æ“´å±•æ¶æ§‹** - æ˜“æ–¼æ–°å¢åŠŸèƒ½

### ä¸‹ä¸€æ­¥è¡Œå‹•

1. âœ… æ‰€æœ‰ç¨‹å¼ç¢¼å·²å®Œæˆ
2. ğŸ”„ **åŸ·è¡Œæ‰‹å‹•æ¸¬è©¦** (ä½ å¯ä»¥é–‹å§‹æ¸¬è©¦äº†!)
3. ğŸ“ æ›´æ–°ä¸» README (èªªæ˜ Integration é¸é …)
4. ğŸš€ å»ºç«‹ GitHub Release
5. ğŸ“¦ æäº¤åˆ° HACS
6. ğŸ“¢ å®£å‚³æ–°åŠŸèƒ½

---

## ğŸ™ è‡´è¬

æ„Ÿè¬ä½ é¸æ“‡å¯¦ä½œ Integration!é€™å€‹æ··åˆæ¶æ§‹æ—¢ä¿ç•™äº† Add-on çš„æ‰€æœ‰åŠŸèƒ½,åˆæä¾›äº†æ›´å¥½çš„ Home Assistant æ•´åˆé«”é©—ã€‚

**ç¾åœ¨ä½ å¯ä»¥é–‹å§‹æ¸¬è©¦ Integration äº†!** ğŸ‰

---

**å»ºç«‹æ—¥æœŸ:** 2025-11-22
**ç‰ˆæœ¬:** Integration v1.0.0
**ä½œè€…:** Claude + @iml885203
