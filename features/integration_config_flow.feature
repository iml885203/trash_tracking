# language: zh-TW
功能: Home Assistant Integration 設定流程
  作為一個 Home Assistant 使用者
  我想要透過原生的 Integration UI 設定垃圾車追蹤
  以便獲得更好的 Home Assistant 整合體驗

  背景:
    假設 垃圾車追蹤 Add-on 正在運行並提供 API
    而且 Add-on API 可以在 "http://localhost:5000" 存取

  # ============================================================
  # 場景 1: 基本的 Integration 安裝流程
  # ============================================================
  場景: 透過 UI 安裝 Integration
    當 我在 Home Assistant 中新增 "Trash Tracking" Integration
    那麼 我應該看到設定表單
    而且 表單應該包含 "API URL" 輸入框
    而且 表單應該包含 "掃描間隔" 輸入框

  場景: 使用預設值設定 Integration
    假設 我在 Integration 設定表單中
    當 我使用預設 API URL "http://localhost:5000"
    而且 我提交設定表單
    那麼 Integration 應該成功連接到 Add-on API
    而且 Integration 應該驗證 API 健康狀態
    而且 Integration 應該建立完成

  場景: 驗證 API 連線失敗
    假設 我在 Integration 設定表單中
    當 我輸入無效的 API URL "http://invalid:9999"
    而且 我提交設定表單
    那麼 應該顯示錯誤訊息 "無法連接到 API"
    而且 Integration 不應該被建立

  場景: 防止重複新增相同的 API URL
    假設 我已經新增了 API URL "http://localhost:5000" 的 Integration
    當 我嘗試再次新增相同的 API URL
    那麼 應該顯示訊息 "此 API URL 已經設定過了"
    而且 應該中止設定流程

  # ============================================================
  # 場景 2: 多步驟智能設定流程 (進階版)
  # ============================================================
  場景: 使用地址自動設定 - 完整流程
    假設 我在 Integration 設定表單中
    而且 我選擇使用 "智能設定模式"

    # Step 1: 輸入地址
    當 我輸入地址 "新北市板橋區中山路一段161號"
    而且 我點擊 "下一步"
    那麼 系統應該開始地理編碼
    而且 系統應該查詢附近的垃圾車路線

    # Step 2: 選擇路線
    而且 我應該看到路線選擇畫面
    而且 應該顯示至少 1 條建議路線
    而且 每條路線應該顯示 "路線名稱"、"車牌號碼" 和 "距離"
    當 我選擇第一條建議路線
    而且 我點擊 "下一步"

    # Step 3: 選擇收集點
    那麼 我應該看到收集點選擇畫面
    而且 應該有 "進入點" 下拉選單
    而且 應該有 "離開點" 下拉選單
    而且 進入點和離開點應該有預設值
    當 我確認收集點選擇
    而且 我點擊 "下一步"

    # Step 4: 進階設定
    那麼 我應該看到進階設定畫面
    而且 應該顯示配置摘要
    而且 我應該能設定 "通知模式"
    而且 我應該能設定 "提前幾站通知"
    當 我選擇通知模式為 "提前通知"
    而且 我設定提前 2 站通知
    而且 我點擊 "完成"

    # 完成
    那麼 Integration 應該建立成功
    而且 應該建立配置包含所選的路線
    而且 應該建立配置包含所選的收集點

  場景: 地址輸入後找不到附近路線
    假設 我在智能設定流程的地址輸入步驟
    當 我輸入偏遠地址 "新北市石碇區某偏遠山區"
    而且 我點擊 "下一步"
    那麼 應該顯示錯誤訊息 "此地址附近沒有找到垃圾車路線"
    而且 我應該能返回修改地址

  場景: 手動選擇不同的收集點
    假設 我在智能設定流程的收集點選擇步驟
    而且 系統已自動選擇 "中山路一段30號" 作為進入點
    當 我手動變更進入點為 "中山路一段50號"
    而且 我手動變更離開點為 "中山路一段120號"
    而且 我完成設定流程
    那麼 最終配置應該使用我手動選擇的收集點

  # ============================================================
  # 場景 3: Options Flow (重新配置)
  # ============================================================
  場景: 修改已安裝 Integration 的設定
    假設 我已經安裝了垃圾車追蹤 Integration
    當 我點擊 Integration 的 "設定選項" 按鈕
    那麼 我應該看到選項設定表單
    而且 我應該能修改 "掃描間隔"
    而且 我應該能修改 "通知模式"
    而且 我應該能修改 "提前幾站通知"

  場景: 透過選項更新掃描間隔
    假設 我在 Integration 選項設定表單中
    而且 目前掃描間隔是 90 秒
    當 我將掃描間隔改為 60 秒
    而且 我儲存選項
    那麼 Integration 應該以新的間隔更新資料
    而且 下次資料更新應該在 60 秒內發生

  # ============================================================
  # 場景 4: 與 Add-on API 整合
  # ============================================================
  場景: Integration 正確讀取 Add-on 的狀態
    假設 垃圾車追蹤 Integration 已安裝並運行
    而且 Add-on 目前追蹤到垃圾車接近
    當 Integration 更新資料
    那麼 Integration 應該從 "/api/trash/status" 獲取資料
    而且 感測器狀態應該顯示為 "nearby"
    而且 垃圾車資訊應該包含在屬性中

  場景: Add-on API 暫時無法連接
    假設 垃圾車追蹤 Integration 已安裝並運行
    當 Add-on 服務停止運行
    而且 Integration 嘗試更新資料
    那麼 Integration 應該標記為 "不可用"
    而且 應該在日誌中記錄連接錯誤
    而且 當 Add-on 恢復運行時應該自動重新連接

  # ============================================================
  # 場景 5: 多個 Integration 實例
  # ============================================================
  場景: 同時追蹤多個不同地點
    假設 我有兩個不同地點需要追蹤垃圾車
    當 我新增第一個 Integration 使用 API URL "http://localhost:5000"
    而且 我新增第二個 Integration 使用 API URL "http://192.168.1.100:5000"
    那麼 兩個 Integration 應該都能正常運作
    而且 每個 Integration 應該有獨立的實體
    而且 實體名稱應該包含唯一識別碼

  場景大綱: 測試不同的掃描間隔設定
    當 我設定掃描間隔為 <間隔> 秒
    那麼 Integration 應該接受該設定
    而且 資料更新頻率應該符合設定值

    例子:
      | 間隔 |
      | 30   |
      | 60   |
      | 90   |
      | 120  |
      | 180  |

  # ============================================================
  # 場景 6: 錯誤處理
  # ============================================================
  場景: API 返回錯誤的資料格式
    假設 垃圾車追蹤 Integration 已安裝並運行
    當 Add-on API 返回無效的 JSON 格式
    那麼 Integration 應該捕獲錯誤
    而且 感測器應該保持上次的有效狀態
    而且 錯誤應該被記錄

  場景: API 健康檢查失敗
    假設 我在設定 Integration
    當 我輸入的 API URL 可以連接但健康檢查失敗
    那麼 應該顯示錯誤訊息 "API 健康檢查失敗"
    而且 應該建議用戶檢查 Add-on 狀態

  # ============================================================
  # 場景 7: 移除 Integration
  # ============================================================
  場景: 完全移除 Integration
    假設 垃圾車追蹤 Integration 已安裝並運行
    當 我刪除該 Integration
    那麼 所有相關的實體應該被移除
    而且 所有相關的設定應該被清除
    而且 不應該再有資料更新請求發送到 Add-on
